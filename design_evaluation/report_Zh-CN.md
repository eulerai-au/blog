# 现有的数据存储设计初步评估

本报告对现有参考工具和目前数据结构设计进行分析，通过对比各自结构以及优缺点，对现有的数据存储设计进行初步评估，并适当提出字段扩充建议。

## 1. 参考工具与当前数据存储设计介绍
### 1.1 MinerU json格式

| 字段名 | 解释 |
| --- | --- |
| pdf_info | list，每个元素都是一个 dict，这个dict是每一页pdf的解析结果 |
| _parse_type |ocr \| txt，用来标识本次解析的中间态使用的模式 |
| _version_name | string，表示本次解析使用的 magic-pdf 的版本号 |

**pdf_info字段结构说明**

| 字段名 | 解释 |
| --- | --- |
| preproc_blocks | pdf预处理后，未分段的中间结果 |
| layout_bboxes | 布局分割的结果， 含有布局的方向（垂直、水平），和bbox，按阅读顺序排序 |
| page_idx | 页码，从0开始 |
| page_size | 页面的宽度和高度 |
| _layout_tree | 布局树状结构 |
| images | list，每个元素是一个dict，每个dict表示一个img_block | 
| tables | list，每个元素是一个dict，每个dict表示一个table_block |
| interline_equations | list，每个元素是一个 dict，每个dict表示一个interline_equation_block | 
| discarded_blocks | list, 模型返回的需要drop的block信息 |
| para_blocks | 将preproc_blocks进行分段之后的结果 |

**一级block**

| 字段名 | 解释 |
| --- | --- |
| type | block类型（table \| image）|
| bbox | block矩形框坐标 |
| blocks | list，里面的每个元素都是一个dict格式的二级block | 

**注**：一级block并非必须存在

**二级block**

| 字段名 | 解释 |
| --- | --- |
| type | block类型 |
| bbox | block矩形框坐标 |
| lines | list，每个元素都是一个dict表示的line，用来描述一行信息的构成 | 

**二级block类型**

| 字段名 | desc |
| --- | --- |
| image_body | 图像的本体 |
| image_caption | 图像的描述文本 |
| image_footnote | 图像的脚注 |
| table_body | 表格本体 | 
| table_caption | 表格的描述文本|
| table_footnote | 表格的脚注 |
| text | 文本块 |
| title | 标题块 |
| index | 目录块 |
| list | 列表块 |
| interline_equation | 行间公式块 |

**lines**

| 字段名 | 解释 |
| --- | --- |
| bbox | line矩形框坐标 |
| span | list， 每个元素都是一个dict表示的span，用来描述一个最小组成单元的构成 |

**span**

| 字段名 | 解释 |
| --- | --- |
| bbox | line矩形框坐标 |
| type | span的类型 |
| content \| img_path | 文本类型的span使用content，图表类使用img_path 用来存储实际的文本或者截图路径信息 |

**span的种类**
| type | desc |
| --- | --- |
| image | 图片 |
| table | 表格 |
| text | 文本 |
| inline_equation | 行内公式 |
| interline_equation | 行间公式 |

### 1.2 Marker json格式

| 字段名 | 解释 |
| --- | --- |
| id | 区块的唯一标识符 |
| block_type | 区块类型 |
| html | 页面的html |
| polygon |  页面的四角多边形，格式为 (x1,y1), (x2,y2), (x3, y3), (x4, y4)。其中 (x1,y1) 是左上角，坐标按顺时针排列。|
| children | 子区块 |

**注**：子区块有两个额外的键
- section_hierarchy： 表示区块所属的章节
- images： base64 编码的图片

### 1.3 现有数据存储设计

| 字段名 | 解释 |
| --- | --- |
| metadata | 文档元信息|
| sections | 章节树，每个对象代表一个标题块 |
| chunks | 文本切片,每个对象是一段定长 token 切片 |
| doc_references | 图、表、公式、引用论文等引用信息,每个对象代表一个引用元素|


**1. metadata**

| 字段名 | 解释 |
| --- | --- |
| title | 论文标题 |
| authors_info | 作者信息 |
| abstract | 摘要 |
| keywords | 关键字 |
| publish_info | 出版信息 |
| doc_id | 文档 ID，SHA-256 哈希 |
| total_pages | 文档总页数 |

**2. sections**

| 字段名 | 解释 |
| --- | --- |
| sec_id | {doc_id}\_sec{n} 唯一标识 |
| name | 标题名称 |
| level |标题层级（1 → 一级标题，2 → 二级…）|
| parent_id | 父章节的 sec_id，根级为 null |
| children_ids | 下级子章节列表 |
| full_path | 从根到本节点的标题路径（字符串列表）|

**3. chunks**

| 字段名 | 解释 |
| --- | --- |
|chunk_id | {doc_id}\_{sec_id}\_chunk{n} |
|sec_id | 所属章节 ID |
| text | 本切片的文本 |
| tokens |本切片经编码器分词后的 token 数量 |
| page_idx | 本切片对应的页码 |
| position_in_section | 在本章节中的序号 |
| ref_ids | 本切片显式或隐式引用到的所有 ref_id列表 |

**4. doc_references**

| 字段名 | 解释 |
| --- | --- |
| ref_id | {doc_id}_ref{m} 唯一标识 |
| type | 元素类型，包括 "image"、"table"、"equation" 、"cite" 、"outer_link"|
| content | 引用的内容，对其他类型为空字符串 |
| path |文件路径 |
| caption | 图/表标题文本，公式为空|
| page_idx | 该元素出现的页码 |
| chunk_ids | 所有包含或引用到本元素的 chunk ID 列表 |

## 2. 参考工具适用性分析


| 特性 / 工具      | Marker                              | MinerU                            |
| ------------ | ----------------------------------- | --------------------------------- |
| **支持的文档类型** |  报告<br> 商业文档<br> 技术文档<br> 简单论文(少图表与公式) |  学术论文<br>科研图表/公式文档<br> 科技白皮书 |
| **识别方式**|基于规则+BERT的结构化提取 | 视觉布局 + 文本识别 + 多模态模型 |
| **结构提取能力** | 强于段落、标题、目录、表格、图片、页眉页脚 | 强于章节、公式、引用、参考文献、表格、图标题 |
| **公式识别能力**   | 一般，内联公式有时会被漏识 | 强（结构化 LaTeX 提取，支持 MathML/LaTeX）   |
| **图表提取能力** | 提取图像，但少图注、图号、无向图结构 | 支持图像 + 图号 + 图注 + 图文绑定 |
| **表格识别能力** | 基于布局识别（强表格结构） | 支持表格 + 表名 + 引用上下文 |
| **引用提取能力** | 一般，只能识别格式化段落 | 强，支持 BibTeX/APA/IEEE 格式提取 |
| **语义结构提取** | 支持标题层次、目录、页码 | 支持章节单层次、段落逻辑分割、图表引用等语义块 |
| **复杂页面支持** | 对复杂布局敏感（排版跳跃时易失败）| 可处理学术文档复杂双栏、多列结构 |
| **支持图文对齐** | 不支持，只支持图片位置 | 支持，图与脚注可对应 |

## 3. 当前数据存储设计适用性分析

### 1.各字段通用分析

| 字段 | 是否通用 | 适用类型 | 原因  |
| --- | --- | --- | --- |
| `metadata`| 强通用性 | 几乎所有文档 | 改模块结构包含了几乎所有文档的元信息 |
| `sections` | 强通用性 | 有标题层级的文档，如论文、法律、教材 | 基于标签提取，支持多级标签  |
| `chunks` | 强通用性 | 所有中长文本 | 按定长token切片适用于LLM，但是会造成语义不完整 |
| `doc_references` | 强通用性 | 包含图表、公式、引用的文档 | 学术/法律/技术文档普遍含有引用对象，支持图文对齐 |

### 2.各文件类型通用分析

| 文档类型 | 通用性说明 |
| --- | --- |
| 学术论文（论文、报告）| 适配性好公式、图表、引用丰富，有层级，适用性好|
| 报告 | 图表居多，公式较少，有层级，适用性好 |
| 行业标准文档 | 条款编号层次清晰，引用图表居多，但是文档元信息较多，适用性一般，可以通过添加额外字段改善 |
| 教材 / 学术书籍 | 多层标题、公式、图表明确，但是文档元信息较多，适用性一般，可以通过添加额外字段改善 |
| 政策法规文档 | 标准标题结构，有引用法条，适用性好 |
| 法律判决书 | 仅包含首部、正文和尾部，无图表、公式以及引用，适用性好  |
| 说明书 / 用户手册 | 有标题、有图、有结构化内容 |
| 新闻、短篇文章 | 没有明显章节结构，没有表格以及引文，可能具有图片，适用性有待考究|
| 小说、文学作品  | 不使用公式、图表、引用，有层级化结构，适用性好 |
| 简历 | 结构化自由文本，可能包含图片，适用性有待考究|
| 证明类材料 |多为表格加一句话说明，不适合结构树，适用性有待考究 |

### 3.结论

目前数据存储设计针对大多数类型文档适用性都较好，少部分元信息较多的文档适用性一般，可通过增加额外字段增强适用性，少部分无明显章节结构以及结构化自由的文档适用性有待考究不好

### 4. 建议

- 考虑论文场景，`"metadata"`中使用"authors_info"保存所有作者全部信息可能会无法清晰分辨作者之间的边界，也无法附带作者的其他信息，检索作者如确定第二作者也可能会造成不便，可以使用数组的形式保存，如类似以下结构，此处额外字段添加应根据论文结构和常见文件格式进行设计

``` json
"authors_info":[
  {
    "name": "A",
    "email": "A@A.com",
    "affiliation": "A"
  },
  {
    "name": "B",
    "email": "B@B.com",
    "affiliation": "B"
  }
]
```

- `"chunk"`以定长token的形式，会导致不同段落混合，以及正文与脚注和表格混合，也会导致表格内容不完整，可以使用其他方式切片，并添加`"type"`字段以区分

- 考虑行业标准文档以及书籍场景，`"metadata"`需要添加额外的字段，如`"extra_info"`，该字段需要包含多种额外信息，应为字典格式

## 5. 存疑点

- `"section"`并不包含章节的页码信息，对此是否会造成不良影响有待考究

- `"chunk"`块会包含表格内容，将表格提取至chunk是否合理有待考究，不过个人觉得不合理

- `"section"`是否是必须，如果针对无结构文档，如成绩单，该部分是否可以为空